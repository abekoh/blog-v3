---
slug: 'setup-vpn'
title: '自宅とGoogle Cloud VPCをVPNで繋いでみる'
summary: ''
categories: [ 'tech' ]
tags: [ 'network', 'gcp' ]
publishedAt: 2024-10-24T23:00:00.000+09:00
modifiedAt:
draft: false
isHtml: false
---

## はじめに

我が家には数年前に組んだ「GeForce RTX 3080搭載のゲーミングPC」があるわけですが、最近はPCゲームをそこまでやらず、それなりのGPUあるのにもったいないなという状態です。

最近はローカルLLMの性能も良くなり、せっかくなのでそれなりのGPU積んだゲーミングPCをAIマシンにして有効活用できないかな、と思い。それなら自宅以外、クラウドからも呼び出せると嬉しいだろうなーと妄想してました。

そのはじめの一歩として、拠点間VPNで自宅とGoogle Cloud VPCを繋ぐ仕組みを整えてみました。そのログです。

## Overview

全体イメージはこちら。Google Cloudのほうはとりあえず疎通確認のためにCompute Engineのみ。自宅のほうはYAMAHAルータを中心にネットワークを構築してみてます。

![Overview](/assets/setup-vpn-overview.png)


## 自宅ネットワークの刷新

自宅の回線はNuro光で、今までZTE F660Aという端末にONU、ルータ、Wi-Fiアクセスポイントすべての役割を任せていました。
Google Cloudとの拠点間VPNをセットアップするためにはIPSecを用いたVPNに対応したルータが必要で、F660Aはそれには対応しておりません。というか家庭向けルータはIPSec VPNに対応しているほうが珍しいです。

そこで界隈では名高い業務用ルータ、YAMAHA製のルータに手を出してみることにしました。なんとなく憧れがあったので良い機会です。

入手したのはこちら[RTX830](https://network.yamaha.com/products/routers/rtx830/index)。希望小売価格なんと101,200円(税込)！
…この値段だと流石にな、とは思いましたが、メルカリで探すと中古2万円程度の出品がたくさんあったので購入。業務用の安定高機能なルータが2万はお買い得な気がします。

ルータが到着して、いざ設定開始。F660AはONU機能のみに限定、ルーティングはすべてRTX830のほうで行ってもらうようにしました。
このあたりの設定は先人のログがたくさん見つかったので参考にさせていただきました。

- [Nuro光 + RTX1200 で VPNが使えるようにする（一部制限あり）- 逸般の誤家庭 向け情報 - ものくろぼっくす](https://mono96.jp/network/yamaha/41783/)
- [Nuro光のONUに自前ルータを接続する - TALKEYBOID Blog](https://talkeyboid.com/entry/2023/01/05/013001)
- [NURO光でF660Aへの接続台数が10台を超えると不安定になる事象を解決する - うっかりエンジニアのメモ](https://entropiajp.hatenablog.com/entry/2022/09/11/202536)

やったことまとめるとざっくり↓

- F660A/LANとRTX830/WANをつなぐ
- F660Aの管理画面にて
  - Wi-FiはOFF、DHCPもOFF
  - RTX830をMACアドレス指定で192.168.1.2にIP固定
  - DMZを設定してすべてのIPパケットがRTX830に届くように
- RTX830の管理画面にて
  - プロバイダー接続で、以下の設定に
    - 接続種別: DHCP 、または固定IPアドレスによる接続
    - インターフェース: WAN

また、Wi-Fiアクセスポイントのために[Aterm WX1500HP](https://www.aterm.jp/product/atermstation/product/warpstar/wx1500hp/)を購入、ブリッジモードでセットしました。

以上が自宅ネットワークの刷新です。

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">YAMAHAルータ導入した。これで我が家も逸般の誤家庭 <a href="https://t.co/aOJvIiMMNN">pic.twitter.com/aOJvIiMMNN</a></p>&mdash; abekoh (@abekoh_bcky) <a href="https://twitter.com/abekoh_bcky/status/1841411320739938346?ref_src=twsrc%5Etfw">October 2, 2024</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

ついでに、ネットワーク途切れる問題も解決したっぽい。

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">YouTube Liveが切れまくる問題がなくなって快適<br>YAMAHAルータだから、というよりONUとルータを分離させたからな気はするけど</p>&mdash; abekoh (@abekoh_bcky) <a href="https://twitter.com/abekoh_bcky/status/1842823471338033349?ref_src=twsrc%5Etfw">October 6, 2024</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


## VPNの設定


## ワンクリックでVPNをON/OFFに

## おわりに
